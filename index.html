<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<title>Transport</title>
<style>
body{
  margin: 0;
  background-color: #901FBA;
  zoom: 25%;
}
canvas{
  position: absolute;
  background-color: none;
  opacity: 0;
  transition: all 1s ease;
}
video{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: -350px;
  opacity: 0;
  transition: all 0.5s ease;
}
</style>
</head>
<body>
<canvas id="bottomUpdate" width="4000"></canvas>
<canvas id="middle" width="4000"></canvas>
<canvas id="stopC" width="4000"></canvas>
<canvas id="topUpdate" width="4000"></canvas>
<video id = "loader" width="2200" height="3600" loop>
  <source src="Videos/Animation_load_1.mp4" type="video/mp4">
Your browser does not support video playback.
</video>
<script src="recycler.js"></script>
<script src="bus.js"></script>
<script src="Stops.js"></script>
<script>
  //getting background image
  var latv=new Image();
  latv.src="Images/LV_2_lv_st_19.png";
  var orangeLayer = new Image();
  orangeLayer.src = "Images/LV_2_orange.png";
  //declaring globbal variables
  var stops;
  var width=8.23;
  var height=3.06;
  var left=20.42;
  var ttop=58.434;
  var mid=left+width/2;
  var acth;
  var actw;
  var busses=[];
  function EyeOpener(Ob, index){//shows all busstops
    var l=coorToCanvas(Ob.degE,Ob.degN);
    stops[index].x=l[0];
    stops[index].y=l[1];
    stx.beginPath();
    stx.arc((l[0]), (l[1]), 2.5/3000*actw, 0, Math.PI*2);
    stx.fill();
    //ctx.fillRect(l[0]-2,l[1]-2,4,4);
  }
  function init(){//initializes canvas and busstops
    mtx=middle.getContext("2d");
    stx=stopC.getContext("2d");
    btx=bottomUpdate.getContext("2d");
    ttx=topUpdate.getContext("2d");
    middle.width=window.innerWidth;
    middle.height=window.innerHeight;
    if((window.innerWidth/window.innerHeight)<(latv.width/latv.height)){
      acth=latv.height*(middle.width/latv.width)*4;
      actw=middle.width*4;
    }else{
      acth=middle.height*4;
      actw=latv.width*(middle.height/latv.height)*4;
    }
    middle.height=acth;
    bottomUpdate.height=acth;
    topUpdate.height=acth;
    middle.width=actw;
    bottomUpdate.width=actw;
    topUpdate.width=actw;
    stopC.height=acth;
    stopC.width=actw;
    SpeedC=SpeedC*actw;
    recycle();//@recycler.js  Gets all files needed and repurpouses them
    waiter();
  }
  function waiter(){//function that waits until the files are fetched
    if(done==false){//@recycler.js
      setTimeout(waiter,10);
      return;
    }
    stops=reA;//@recycler.js
    //middle
    loader.style.opacity = "0";
    setTimeout(function(){
      bottomUpdate.style.opacity = "1";
      middle.style.opacity = "1";
      topUpdate.style.opacity = "1";
      stopC.style.opacity = "1";
    }, 800);
    mtx.drawImage(latv,0,0,middle.width,middle.height);
    //btx.drawImage(orangeLayer,-middle.width,-middle.height,middle.width*2,middle.height*2);
    mtx.strokeStyle="black";
    mtx.fillStyle="white";
    mtx.lineWidth = 2;

    stops.forEach(EyeOpener);
    //busses
    for(var i=0;i<20;i++){
      busses.push(new Bus([stops[random(0,8000)],stops[random(0,8000)],stops[random(0,8000)]]));
    }
    setTimeout(update,10);
  }
  function random(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
  function update(){//main update
    var date=new Date().getTime();
    ttx.clearRect(0,0,actw,acth);
    ttx.fillStyle="red";
    busses.forEach(BusUpdate);//@bus.js
    setTimeout(update,1);
  }
  function StopDraw(Ob){
    stx.beginPath();
    stx.arc(Ob.x-2, Ob.y-2, 2.5, 0, Math.PI*2);
    stx.stroke();
  }
  function coorToCanvas(E,N){
    var x=(E-left)*middle.width/width;
    var y=((ttop-N)*middle.height/height);
    return [x,y];
  }
  function fadeIn(){
    loader.style.opacity = "1";
    document.getElementById("loader").play();
    setTimeout(init, 2300);
  }
  window.addEventListener('load', fadeIn, false);
</script>
</body>
</html>
